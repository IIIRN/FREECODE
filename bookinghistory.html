<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการนัดหมาย</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
        window.onload = function () {
            initializeLiff(),getUserProfile();
        };
        async function initializeLiff() {
            await liff.init({ liffId: '2005629952-2p0n3ERO' }); // Replace with your LIFF ID
            if (liff.isLoggedIn()) {
                getUserProfile();
            } else {
                liff.login();
            }
        }
        async function getUserProfile() {
            try {
                const profile = await liff.getProfile();
                document.getElementById('userlineid').value = profile.userId;
                document.getElementById('displayName').value = profile.displayName;
                // Trigger search when user ID is retrieved
                searchData();
            } catch (error) {
                console.error('Error getting profile data:', error);
            }
        }
    </script>
</head>
<body class="bg-gray-100 m-5">
    <div class="max-w-lg mx-auto mt-10 bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-6">ประวัติการนัดหมาย</h1>
        <div class="mb-6">
            <input id="userlineid" type="text" class="border p-2 rounded-md w-full" placeholder="กรอก User Line ID เพื่อกรองนัดหมาย">
            <button onclick="applyFilter()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-md">กรอง</button>
        </div>
        <div id="historyTable" class="space-y-4">
            <!-- การนัดหมายจะถูกแสดงที่นี่ -->
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Apply initial filter when content is loaded.
            applyFilter();
        });

        async function fetchHistory(userlineid = '') {
            try {
                if (!userlineid) {
                    // If userlineid is empty, clear the display.
                    displayHistory([]);
                    return;
                }

                const response = await fetch('https://script.google.com/macros/s/AKfycbxiCwD7UcEyCwtecXM84ycj_RhW3xXQngdt-BONQVJK1S43Np9hSRdaxH3IyhjFnYO0/exec?action=fetchBookings');
                if (!response.ok) throw new Error('Network response was not ok');

                const bookings = await response.json();
                const filteredBookings = bookings.filter(booking => booking.userlineid === userlineid);
                displayHistory(filteredBookings);
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลได้ โปรดลองใหม่อีกครั้ง', 'error');
            }
        }

        function displayHistory(bookings) {
            const historyTable = document.getElementById('historyTable');
            historyTable.innerHTML = '';
            if (bookings.length === 0) {
                historyTable.innerHTML = '<p class="text-center text-gray-500">ไม่มีข้อมูลการนัดหมาย</p>';
                return;
            }
            bookings.forEach((booking, index) => {
                const bookingDiv = document.createElement('div');
                bookingDiv.classList.add('bg-gray-200', 'p-4', 'rounded-md', 'space-y-2');
                
                let cancelButtonHtml = '';
                if (booking.status !== 'ยกเลิก') {
                    cancelButtonHtml = `<button class="px-4 py-2 bg-red-500 text-white rounded-md" onclick="cancelBooking(${index})">ยกเลิกนัดหมาย</button>`;
                }

                bookingDiv.innerHTML = `
                    <p><strong>บริการ:</strong> ${booking.service}</p>
                    <p><strong>บุคลากร:</strong> ${booking.personnel}</p>
                    <p><strong>วันที่/เวลา:</strong> ${booking.date}</p>
                    <p><strong>ยืนยันด้วยโทรศัพย์:</strong> ${booking.time}</p>
                    <p><strong>สถานะ:</strong> ${booking.status}</p>
                    ${cancelButtonHtml}
                `;
                
                historyTable.appendChild(bookingDiv);
            });
        }

        function applyFilter() {
            const filterInput = document.getElementById('userlineid').value.trim();
            fetchHistory(userlineid);
        }

        async function cancelBooking(index) {
            try {
                const result = await Swal.fire({
                    title: 'ยืนยันการยกเลิกนัดหมาย',
                    text: 'คุณแน่ใจว่าต้องการยกเลิกนัดหมายนี้หรือไม่?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ใช่, ยกเลิกมัน!',
                    cancelButtonText: 'ยกเลิก'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`https://script.google.com/macros/s/AKfycbxiCwD7UcEyCwtecXM84ycj_RhW3xXQngdt-BONQVJK1S43Np9hSRdaxH3IyhjFnYO0/exec?action=cancelBooking&id=${index}`, {
                        method: 'POST'
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    Swal.fire('สำเร็จ!', 'นัดหมายถูกยกเลิก', 'success');
                    applyFilter(); // Refresh the filtered results after cancellation.
                }
            } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
                Swal.fire('เกิดข้อผิดพลาด', 'ไม่สามารถยกเลิกนัดหมายได้ โปรดลองใหม่อีกครั้ง', 'error');
            }
        }
    </script>
</body>
</html>
